ARG BASE_IMAGE=ubuntu:24.04
FROM $BASE_IMAGE
ARG IS_CHINA=false
LABEL maintainer "hengli"
LABEL page "https://github.com/poptree"

ENV DEBIAN_FRONTEND=noninteractive
ENV USER=ubuntu \
    PASSWORD=ubuntu \
    UID=1000 \
    GID=1000

ENV NVIDIA_VISIBLE_DEVICES=all
ENV NVIDIA_DRIVER_CAPABILITIES=all
ENV HTTPS_CERT=/etc/ssl/certs/ssl-cert-snakeoil.pem
ENV HTTPS_CERT_KEY=/etc/ssl/private/ssl-cert-snakeoil.key
ENV VGL_DISPLAY=egl
ENV REMOTE_DESKTOP=kasmvnc
ENV VNC_THREADS=2



# Remove default user ubuntu if exist
RUN userdel ubuntu || true
RUN if [ "$IS_CHINA" = true ]; then \
sed -i s@/archive.ubuntu.com/@/mirrors.aliyun.com/@g /etc/apt/sources.list ; \
apt-get clean \
    else \
    echo "DO NOT USE MIRROR" ; \
fi

## Install and Configure OpenGL
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        libxau6 libxdmcp6 libxcb1 libxext6 libx11-6 \
        libglvnd0 libgl1 libglx0 libegl1 libgles2 \
        libglvnd-dev libgl1-mesa-dev libegl1-mesa-dev libgles2-mesa-dev && \
    rm -rf /var/lib/apt/lists/* && \
    mkdir -p /usr/share/glvnd/egl_vendor.d/ && \
    echo "{\n\
\"file_format_version\" : \"1.0.0\",\n\
\"ICD\": {\n\
    \"library_path\": \"libEGL_nvidia.so.0\"\n\
}\n\
}" > /usr/share/glvnd/egl_vendor.d/10_nvidia.json

## Install and Configure Vulkan
RUN apt-get update && \
    apt-get install -y --no-install-recommends vulkan-tools && \
    rm -rf /var/lib/apt/lists/* && \
    VULKAN_API_VERSION=$(dpkg -s libvulkan1 | grep -oP 'Version: [0-9|\.]+' | grep -oP '[0-9]+(\.[0-9]+)(\.[0-9]+)') && \
    mkdir -p /etc/vulkan/icd.d/ && \
    echo "{\n\
\"file_format_version\" : \"1.0.0\",\n\
\"ICD\": {\n\
    \"library_path\": \"libGLX_nvidia.so.0\",\n\
        \"api_version\" : \"${VULKAN_API_VERSION}\"\n\
}\n\
}" > /etc/vulkan/icd.d/nvidia_icd.json
## Copy config
COPY docker_config /docker_config
## Install some common tools 
RUN bash /docker_config/pre_install.sh &&\
    rm -rf /var/lib/apt/lists/* 

## Install desktop
RUN apt-get update 
RUN add-apt-repository -y ppa:mozillateam/ppa &&\
    mkdir -p /etc/apt/preferences.d &&\
    echo "Package: firefox*\n\
Pin: release o=LP-PPA-mozillateam\n\
Pin-Priority: 1001" > /etc/apt/preferences.d/mozilla-firefox 
    # install xfce4 and firefox
RUN apt-get install -y xfce4 terminator fonts-wqy-zenhei ffmpeg firefox 
# dbus-x11
    # remove and disable screensaver
RUN apt-get remove -y xfce4-screensaver --purge &&\
    # set firefox as default web browser
    update-alternatives --set x-www-browser /usr/bin/firefox &&\
    rm -rf /var/lib/apt/lists/*

ENV DBUS_SYSTEM_BUS_ADDRESS=unix:path=/host/run/dbus/system_bus_socket
RUN apt-get update && apt-get install -y pulseaudio && mkdir -p /var/run/dbus &&\
    rm -rf /var/lib/apt/lists/*

## Configure ssh 
RUN bash /docker_config/config_ssh.sh

## Install Jupyterlab
RUN if [ "$IS_CHINA" = true ] ; then \
python -m pip install --upgrade -i https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple pip  ; \
pip config set global.index-url https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple ; \
else \
echo "DO NOT USE PIP MIRROR"; \
fi
RUN bash /docker_config/config_jupyterlab.sh

## Install remote desktop and other apps
RUN bash /docker_config/post_install.sh &&\
    rm -rf /var/lib/apt/lists/*

EXPOSE 22 4000
CMD ["/usr/sbin/sshd", "-D"]
# ENTRYPOINT ["/docker_config/entrypoint_autodl.sh"]
# ENTRYPOINT ["/docker_config/entrypoint_autodl.sh"]
